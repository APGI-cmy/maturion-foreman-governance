name: Governance Scope-to-Diff Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  scope-to-diff:
    name: Enforce Scope-to-Diff Alignment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch PR diff
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1

      - name: Load declared responsibility
        run: |
          if [ ! -f "governance/scope-declaration.md" ]; then
            echo "❌ GOVERNANCE BLOCK: Missing scope declaration."
            exit 1
          fi

          DOMAIN=$(grep "RESPONSIBILITY_DOMAIN:" governance/scope-declaration.md | cut -d':' -f2 | xargs)
          if [ -z "$DOMAIN" ]; then
            echo "❌ GOVERNANCE BLOCK: Responsibility domain not declared."
            exit 1
          fi

          echo "RESP_DOMAIN=$DOMAIN" >> $GITHUB_ENV

      - name: Enforce file alignment
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }})

          echo "Changed files:"
          echo "$CHANGED_FILES"

          for FILE in $CHANGED_FILES; do
            case "$RESP_DOMAIN" in
              "Database lifecycle")
                [[ "$FILE" =~ ^(prisma|migrations|db|schema)/ ]] || {
                  echo "❌ SCOPE VIOLATION: $FILE outside Database lifecycle"
                  exit 1
                }
                ;;
              "Email delivery")
                [[ "$FILE" =~ ^(email|mail|templates)/ ]] || {
                  echo "❌ SCOPE VIOLATION: $FILE outside Email delivery"
                  exit 1
                }
                ;;
              "CI infrastructure")
                [[ "$FILE" =~ ^\.github/workflows/ ]] || {
                  echo "❌ SCOPE VIOLATION: $FILE outside CI infrastructure"
                  exit 1
                }
                ;;
              *)
                echo "❌ GOVERNANCE BLOCK: Unknown responsibility domain '$RESP_DOMAIN'"
                exit 1
                ;;
            esac
          done

          echo "✅ Scope-to-diff alignment enforced"
