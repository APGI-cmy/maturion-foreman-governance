name: Governance Layer-Down Dispatch

# TERMINOLOGY NOTE (2026-02-21):
# This workflow implements LAYER-DOWN (cross-repo distribution of governance artifacts).
# "Rippling" refers to within-repo integration and occurs in consumer repos after layer-down.
# See ECOSYSTEM_VOCABULARY.md v1.1.0 and LAYERING_AND_RIPPLING_AUTOMATION_STRATEGY.md.

on:
  push:
    branches:
      - main
    paths:
      - 'governance/**'
      - 'BUILD_PHILOSOPHY.md'
      - '.github/workflows/**'

jobs:
  dispatch-layer-down:
    name: Dispatch Governance Layer-Down to Consumer Repos
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout governance repo
        uses: actions/checkout@v4
      
      - name: Read consumer registry
        id: registry
        run: |
          if [ ! -f "governance/CONSUMER_REPO_REGISTRY.json" ]; then
            echo "‚ùå FATAL: Consumer registry not found"
            exit 1
          fi
          
          # Extract enabled consumer repos
          CONSUMERS=$(jq -r '.consumers[] | select(.enabled == true) | .repository' governance/CONSUMER_REPO_REGISTRY.json)
          echo "consumers<<EOF" >> $GITHUB_OUTPUT
          echo "$CONSUMERS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "üì° Will dispatch layer-down to:"
          echo "$CONSUMERS"
      
      - name: Dispatch layer-down events
        env:
          GH_TOKEN: ${{ secrets.MATURION_BOT_TOKEN }}
        run: |
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          
          echo "${{ steps.registry.outputs.consumers }}" | while read -r repo; do
            [ -z "$repo" ] && continue
            
            echo "üì§ Dispatching layer-down to $repo..."
            
            gh api repos/$repo/dispatches \
              -X POST \
              -H "Accept: application/vnd.github+json" \
              -f event_type="governance_layer_down" \
              -f client_payload[source_repo]="APGI-cmy/maturion-foreman-governance" \
              -f client_payload[commit_sha]="$COMMIT_SHA" \
              -f client_payload[commit_message]="$COMMIT_MESSAGE" \
              -f client_payload[timestamp]="$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              && echo "  ‚úÖ Dispatched successfully" \
              || echo "  ‚ùå Dispatch failed"
          done
      
      - name: Record layer-down dispatch
        run: |
          mkdir -p .agent-admin/layer-down
          cat > .agent-admin/layer-down/dispatch-$(date +%Y%m%d-%H%M%S).json <<EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit_sha": "${{ github.sha }}",
            "commit_message": "${{ github.event.head_commit.message }}",
            "consumers_notified": $(jq -c '[.consumers[] | select(.enabled == true) | .repository]' governance/CONSUMER_REPO_REGISTRY.json)
          }
          EOF
          
          echo "‚úÖ Layer-down dispatch recorded"
