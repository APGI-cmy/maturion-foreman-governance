name: Locked Section Protection Gate

on:
  pull_request:
    paths:
      - '.github/agents/**/*.agent.md'
      - '.github/agents/**/*.md'
      - '.agent'
  push:
    branches:
      - main
    paths:
      - '.github/agents/**/*.agent.md'
      - '.github/agents/**/*.md'
      - '.agent'

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-locked-sections:
    name: Validate Locked Section Integrity
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to check diffs
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install PyYAML
      
      - name: Check for PREHANDOVER_PROOF evidence-based validation
        id: check_evidence
        run: |
          echo "Checking for evidence-based validation in PREHANDOVER_PROOF..."
          
          # Check if PREHANDOVER_PROOF.md exists
          if [ -f "PREHANDOVER_PROOF.md" ]; then
            echo "evidence_file_exists=true" >> $GITHUB_OUTPUT
            
            # Check if it contains locked section validation evidence
            if grep -qi "locked.*section\|locked section validation\|check_locked_sections" PREHANDOVER_PROOF.md; then
              echo "evidence_found=true" >> $GITHUB_OUTPUT
              echo "‚úì PREHANDOVER_PROOF.md contains locked section validation evidence"
              
              # Check for attestation/signature and exit code 0
              if grep -qi "attestation\|signature\|manually verified\|evidence-based" PREHANDOVER_PROOF.md && \
                 grep -qi "exit code.*0\|exit.*code.*0\|exit: 0" PREHANDOVER_PROOF.md; then
                echo "attestation_found=true" >> $GITHUB_OUTPUT
                echo "‚úì Attestation/signature and exit code 0 found in PREHANDOVER_PROOF"
              else
                echo "attestation_found=false" >> $GITHUB_OUTPUT
                echo "‚ö†Ô∏è Missing attestation/signature or exit code 0 in PREHANDOVER_PROOF"
              fi
            else
              echo "evidence_found=false" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è PREHANDOVER_PROOF.md exists but no locked section validation evidence found"
            fi
          else
            echo "evidence_file_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è PREHANDOVER_PROOF.md not found"
          fi
      
      - name: Check for locked section modifications
        id: check_modifications
        continue-on-error: true
        run: |
          python .github/scripts/check_locked_sections.py \
            --mode=detect-modifications \
            --base-ref=${{ github.event.pull_request.base.sha || 'main' }} \
            --head-ref=${{ github.sha }}
      
      - name: Validate locked section metadata
        id: validate_metadata
        continue-on-error: true
        run: |
          python .github/scripts/check_locked_sections.py \
            --mode=validate-metadata \
            --contracts-dir=.github/agents
          echo "metadata_exit_code=$?" >> $GITHUB_OUTPUT
      
      - name: Verify protection registry sync
        id: verify_registry
        continue-on-error: true
        run: |
          python .github/scripts/check_locked_sections.py \
            --mode=verify-registry \
            --contracts-dir=.github/agents \
            --registry-file=governance/contracts/protection-registry.md
          echo "registry_exit_code=$?" >> $GITHUB_OUTPUT
      
      - name: Determine validation result
        id: determine_result
        run: |
          MODIFICATIONS_RESULT="${{ steps.check_modifications.outcome }}"
          METADATA_RESULT="${{ steps.validate_metadata.outcome }}"
          REGISTRY_RESULT="${{ steps.verify_registry.outcome }}"
          EVIDENCE_EXISTS="${{ steps.check_evidence.outputs.evidence_file_exists }}"
          EVIDENCE_FOUND="${{ steps.check_evidence.outputs.evidence_found }}"
          ATTESTATION_FOUND="${{ steps.check_evidence.outputs.attestation_found }}"
          
          echo "==================================="
          echo "Locked Section Validation Results"
          echo "==================================="
          echo ""
          echo "Script execution - modifications check: $MODIFICATIONS_RESULT"
          echo "Script execution - metadata validation: $METADATA_RESULT"
          echo "Script execution - registry verification: $REGISTRY_RESULT"
          echo "Evidence-based validation available: $EVIDENCE_EXISTS"
          echo "Evidence found: $EVIDENCE_FOUND"
          echo "Attestation found: $ATTESTATION_FOUND"
          echo ""
          
          # Check Path 1: Script execution succeeded
          if [ "$MODIFICATIONS_RESULT" = "success" ] && [ "$METADATA_RESULT" = "success" ]; then
            echo "‚úÖ PASS: Script execution path succeeded"
            echo "result=pass" >> $GITHUB_OUTPUT
            echo "method=script" >> $GITHUB_OUTPUT
            echo "locked_sections_modified=${{ steps.check_modifications.outputs.locked_sections_modified }}" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check Path 2: Evidence-based validation
          if [ "$EVIDENCE_EXISTS" = "true" ] && [ "$EVIDENCE_FOUND" = "true" ] && [ "$ATTESTATION_FOUND" = "true" ]; then
            echo "‚úÖ PASS: Evidence-based validation path accepted"
            echo "result=pass" >> $GITHUB_OUTPUT
            echo "method=evidence" >> $GITHUB_OUTPUT
            echo "locked_sections_modified=false" >> $GITHUB_OUTPUT
            echo ""
            echo "Note: This PR used evidence-based validation (BL-027/028 compliant)"
            echo "PREHANDOVER_PROOF contains manual locked section validation with attestation"
            exit 0
          fi
          
          # Neither path succeeded - FAIL
          echo "‚ùå FAIL: Neither validation path succeeded"
          echo "result=fail" >> $GITHUB_OUTPUT
          echo "method=none" >> $GITHUB_OUTPUT
          echo "locked_sections_modified=false" >> $GITHUB_OUTPUT
          echo ""
          echo "Locked section validation requires ONE of these paths:"
          echo ""
          echo "PATH 1: Script Execution (Preferred)"
          echo "  - check_locked_sections.py available: ‚úÖ"
          echo "  - Modifications check passed: $([[ $MODIFICATIONS_RESULT = 'success' ]] && echo '‚úÖ' || echo '‚ùå')"
          echo "  - Metadata validation passed: $([[ $METADATA_RESULT = 'success' ]] && echo '‚úÖ' || echo '‚ùå')"
          echo ""
          echo "PATH 2: Evidence-Based Validation (Agent Environments)"
          echo "  - PREHANDOVER_PROOF exists: $([[ $EVIDENCE_EXISTS = 'true' ]] && echo '‚úÖ' || echo '‚ùå')"
          echo "  - Contains locked section validation: $([[ $EVIDENCE_FOUND = 'true' ]] && echo '‚úÖ' || echo '‚ùå')"
          echo "  - Contains attestation + exit code 0: $([[ $ATTESTATION_FOUND = 'true' ]] && echo '‚úÖ' || echo '‚ùå')"
          echo ""
          echo "See .github/scripts/README.md for detailed examples of both paths"
          echo ""
          exit 1
      
      - name: Check for CS2 approval
        if: steps.determine_result.outputs.locked_sections_modified == 'true'
        run: |
          # Check if PR has locked-section-approved label or CS2 approval comment
          APPROVED_LABEL=$(gh pr view ${{ github.event.pull_request.number }} --json labels --jq '.labels[].name | select(. == "locked-section-approved")')
          
          if [ -z "$APPROVED_LABEL" ]; then
            echo "‚ùå LOCKED SECTION MODIFICATION DETECTED WITHOUT APPROVAL"
            echo ""
            echo "One or more locked sections were modified in this PR."
            echo "Locked sections require explicit CS2 (Johan Ras/Maturion) approval."
            echo ""
            echo "Modified Lock IDs:"
            cat /tmp/modified_lock_ids.txt || echo "  (See check_locked_sections.py output above)"
            echo ""
            echo "To proceed:"
            echo "1. Create a locked section change request using governance/templates/LOCKED_SECTION_CHANGE_REQUEST_TEMPLATE.md"
            echo "2. Submit to governance/agent-contract-instructions/pending/"
            echo "3. Obtain CS2 approval"
            echo "4. Add 'locked-section-approved' label to this PR"
            echo "5. Reference the approved change request in PR description"
            echo ""
            echo "Authority: governance/canon/AGENT_CONTRACT_PROTECTION_PROTOCOL.md"
            exit 1
          fi
          
          echo "‚úÖ Locked section modification approved (locked-section-approved label present)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate gate summary
        if: always()
        run: |
          echo "## üîí Locked Section Protection Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          RESULT="${{ steps.determine_result.outputs.result }}"
          METHOD="${{ steps.determine_result.outputs.method }}"
          
          if [ "$RESULT" = "pass" ]; then
            echo "### ‚úÖ PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Validation Method**: $METHOD" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$METHOD" = "evidence" ]; then
              echo "**Note**: This PR used evidence-based validation (BL-027/028 compliant)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### ‚ùå FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Neither validation path succeeded. See workflow logs for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.determine_result.outputs.locked_sections_modified }}" = "true" ]; then
            echo "### ‚ö†Ô∏è Locked Section Modifications Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This PR modifies locked sections. CS2 approval required." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Modified Lock IDs:" >> $GITHUB_STEP_SUMMARY
            cat /tmp/modified_lock_ids.txt >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "  (See logs above)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚úÖ No Locked Section Modifications" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This PR does not modify any locked sections." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Overall Result**: $RESULT" >> $GITHUB_STEP_SUMMARY
          echo "- **Validation Method**: $METHOD" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Authority**: \`governance/canon/AGENT_CONTRACT_PROTECTION_PROTOCOL.md\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Comment on PR (if modifications detected)
        if: steps.determine_result.outputs.locked_sections_modified == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const modifiedLocks = process.env.MODIFIED_LOCKS || 'See gate logs';
            const body = `## üîí Locked Section Protection Gate
            
            ‚ö†Ô∏è **This PR modifies locked agent contract sections**
            
            Modified Lock IDs:
            ${modifiedLocks}
            
            **Required Actions:**
            1. Create locked section change request using \`governance/templates/LOCKED_SECTION_CHANGE_REQUEST_TEMPLATE.md\`
            2. Submit to \`governance/agent-contract-instructions/pending/\`
            3. Obtain CS2 (Johan Ras/Maturion) approval
            4. Add \`locked-section-approved\` label to this PR
            5. Reference approved change request in PR description
            
            **Authority**: \`governance/canon/AGENT_CONTRACT_PROTECTION_PROTOCOL.md\`
            
            ---
            
            This gate enforces constitutional protection of governance-critical agent contract requirements.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
        env:
          MODIFIED_LOCKS: ${{ steps.determine_result.outputs.modified_locks }}

      - name: Final gate status
        run: |
          if [ "${{ steps.determine_result.outputs.result }}" = "pass" ]; then
            echo "‚úÖ Locked Section Protection Gate PASSED"
            exit 0
          else
            echo "‚ùå Locked Section Protection Gate FAILED"
            exit 1
          fi
