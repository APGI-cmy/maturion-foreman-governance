name: Governance Scope Declaration Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  scope-declaration-gate:
    name: Enforce Scope Declaration (Single Responsibility)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify scope declaration exists
        run: |
          if [ ! -f "governance/scope-declaration.md" ]; then
            echo "❌ GOVERNANCE BLOCK: Missing scope declaration."
            echo "A valid scope declaration is mandatory before any PR may proceed."
            exit 1
          fi
          echo "✅ scope-declaration.md found"

      - name: Validate required schema markers
        run: |
          FILE="governance/scope-declaration.md"

          REQUIRED_MARKERS=(
            "SCOPE_SCHEMA_VERSION: v1"
            "RESPONSIBILITY_DOMAIN:"
            "IN_SCOPE:"
            "OUT_OF_SCOPE:"
            "EXPECTED_VERIFICATION:"
            "SCOPE_FROZEN: YES"
          )

          for MARKER in "${REQUIRED_MARKERS[@]}"; do
            if ! grep -q "$MARKER" "$FILE"; then
              echo "❌ GOVERNANCE BLOCK: scope declaration missing marker: $MARKER"
              exit 1
            fi
          done

          echo "✅ Required schema markers present"

      - name: Enforce single responsibility domain
        run: |
          DOMAIN_COUNT=$(grep -c "^RESPONSIBILITY_DOMAIN:" governance/scope-declaration.md)
          if [ "$DOMAIN_COUNT" -ne 1 ]; then
            echo "❌ GOVERNANCE BLOCK: Exactly one responsibility domain must be declared."
            exit 1
          fi

          echo "✅ Single responsibility domain enforced"

      - name: Scope Declaration Gate Passed
        run: |
          echo "✅ GOVERNANCE SCOPE DECLARATION GATE PASSED"
          echo "PR scope is declared, frozen, and enforceable."
