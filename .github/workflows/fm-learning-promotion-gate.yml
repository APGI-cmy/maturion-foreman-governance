name: FM Learning Promotion Gate (Governance Required)

on:
  pull_request:
    paths:
      - "architecture/**"
      - ".agent"
      - ".github/workflows/**"
  push:
    branches:
      - main

jobs:
  fm-learning-promotion-gate:
    name: Enforce Governance Promotion on Learning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for Evidence-Based Validation (BL-027/028)
        id: evidence_check
        run: |
          echo "=== Evidence-Based Validation Check (BL-027/028) ==="
          echo "Gate: FM Learning Promotion"
          echo ""
          
          # Look for PREHANDOVER_PROOF with FM learning promotion validation documented
          if [ -f "PREHANDOVER_PROOF.md" ] && grep -Eqi "Learning.*(Promotion|promotion)" PREHANDOVER_PROOF.md; then
            echo "✅ Found PREHANDOVER_PROOF.md with FM Learning Promotion validation"
            echo "✅ ACCEPTING evidence-based validation per BL-027/028"
            echo "skip_execution=true" >> $GITHUB_OUTPUT
          elif ls PREHANDOVER_PROOF_*.md 1> /dev/null 2>&1 && grep -Eqi "Learning.*(Promotion|promotion)" PREHANDOVER_PROOF_*.md 2>/dev/null; then
            echo "✅ Found PREHANDOVER_PROOF with FM Learning Promotion validation"
            echo "✅ ACCEPTING evidence-based validation per BL-027/028"
            echo "skip_execution=true" >> $GITHUB_OUTPUT
          else
            echo "ℹ️  No evidence-based validation found - proceeding with validation"
            echo "skip_execution=false" >> $GITHUB_OUTPUT
          fi

      - name: Resolve active build
        if: steps.evidence_check.outputs.skip_execution != 'true'
        run: |
          if [ ! -f "architecture/BUILD_ACTIVE" ]; then
            echo "ℹ️ No active build (BUILD_ACTIVE missing). Skipping learning promotion gate."
            echo "SKIP_VALIDATION=true" >> $GITHUB_ENV
            exit 0
          fi

          BUILD_ID="$(cat architecture/BUILD_ACTIVE | tr -d '\r' | tr -d '\n')"
          BUILD_DIR="architecture/builds/${BUILD_ID}"

          if [ ! -f "${BUILD_DIR}/learning.md" ]; then
            echo "❌ GOVERNANCE BLOCK: learning.md missing."
            exit 1
          fi

          echo "BUILD_DIR=${BUILD_DIR}" >> $GITHUB_ENV
          echo "SKIP_VALIDATION=false" >> $GITHUB_ENV

      - name: Enforce governance promotion when required
        if: env.SKIP_VALIDATION != 'true'
        run: |
          LEARNING_FILE="${BUILD_DIR}/learning.md"

          GOV_REQUIRED=$(grep "GOVERNANCE_UPDATE_REQUIRED:" "$LEARNING_FILE" | awk '{print $2}')
          EVIDENCE=$(grep "EVIDENCE_LINKS:" "$LEARNING_FILE" | sed 's/EVIDENCE_LINKS://')

          if [ "$GOV_REQUIRED" = "YES" ]; then
            if [ -z "$EVIDENCE" ]; then
              echo "❌ GOVERNANCE BLOCK: Governance update required but no evidence provided."
              echo "Learning cannot be resolved without governance promotion."
              echo "Agent state: ESCALATE / HALT. Never conclude."
              exit 1
            fi

            if ! echo "$EVIDENCE" | grep -E "github.com/.+/pull|github.com/.+/issues"; then
              echo "❌ GOVERNANCE BLOCK: Evidence does not reference a governance PR or issue."
              echo "Governance update must be proposed or tracked."
              echo "Agent state: ESCALATE / HALT. Never conclude."
              exit 1
            fi
          fi

          echo "✅ Governance promotion requirement satisfied"

      - name: Governance Promotion Gate Passed
        if: env.SKIP_VALIDATION != 'true'
        run: |
          echo "✅ FM LEARNING PROMOTION GATE PASSED"
          echo "All required governance updates are referenced and tracked."
