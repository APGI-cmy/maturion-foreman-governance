name: Governance Ripple Dispatch

on:
  push:
    branches:
      - main
    paths:
      - 'governance/**'
      - 'BUILD_PHILOSOPHY.md'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual dispatch (e.g., smoke test, replay)'
        required: false
        default: 'Manual smoke test'

jobs:
  dispatch-ripple:
    name: Dispatch Governance Ripple to Consumers
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout governance repo
        uses: actions/checkout@v4
      
      - name: Read consumer registry
        id: registry
        run: |
          if [ ! -f "governance/CONSUMER_REPO_REGISTRY.json" ]; then
            echo "‚ùå FATAL: Consumer registry not found"
            exit 1
          fi
          
          # Extract enabled consumer repos
          CONSUMERS=$(jq -r '.consumers[] | select(.enabled == true) | .repository' governance/CONSUMER_REPO_REGISTRY.json)
          echo "consumers<<EOF" >> $GITHUB_OUTPUT
          echo "$CONSUMERS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "üì° Will dispatch ripple to:"
          echo "$CONSUMERS"
      
      - name: Dispatch ripple events
        env:
          GH_TOKEN: ${{ secrets.MATURION_BOT_TOKEN }}
        run: |
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          DISPATCH_REASON="${{ github.event.inputs.reason || 'Auto dispatch from push' }}"
          
          echo "üìã Dispatch reason: $DISPATCH_REASON"
          
          echo "${{ steps.registry.outputs.consumers }}" | while read -r repo; do
            [ -z "$repo" ] && continue
            
            echo "üì§ Dispatching ripple to $repo..."
            
            gh api repos/$repo/dispatches \
              -X POST \
              -H "Accept: application/vnd.github+json" \
              -f event_type="governance_ripple" \
              -f client_payload[source_repo]="APGI-cmy/maturion-foreman-governance" \
              -f client_payload[commit_sha]="$COMMIT_SHA" \
              -f client_payload[commit_message]="$COMMIT_MESSAGE" \
              -f client_payload[dispatch_reason]="$DISPATCH_REASON" \
              -f client_payload[timestamp]="$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              && echo "  ‚úÖ Dispatched successfully" \
              || echo "  ‚ùå Dispatch failed"
          done
      
      - name: Record ripple dispatch
        run: |
          mkdir -p .agent-admin/ripple
          cat > .agent-admin/ripple/dispatch-$(date +%Y%m%d-%H%M%S).json <<EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit_sha": "${{ github.sha }}",
            "commit_message": "${{ github.event.head_commit.message }}",
            "consumers_notified": $(jq -c '[.consumers[] | select(.enabled == true) | .repository]' governance/CONSUMER_REPO_REGISTRY.json)
          }
          EOF
          
          echo "‚úÖ Ripple dispatch recorded"
