  - name: Enforce scope-to-diff via registry
        run: |
          DOMAIN=$(grep "RESPONSIBILITY_DOMAIN:" governance/scope-declaration.md | cut -d':' -f2 | xargs)

          REGISTRY="governance/canon/RESPONSIBILITY_DOMAIN_REGISTRY.md"
          if ! grep -q "### DOMAIN: $DOMAIN" "$REGISTRY"; then
            echo "❌ GOVERNANCE BLOCK: Responsibility domain '$DOMAIN' is not registered."
            exit 1
          fi

          echo "Using responsibility domain: $DOMAIN"

          ALLOWED=$(awk "/### DOMAIN: $DOMAIN/{flag=1} /Allowed Paths/{getline; while (\$0 ~ /^-/) {print \$2; getline}} flag && /Forbidden Paths/{exit}" "$REGISTRY")
          FORBIDDEN=$(awk "/### DOMAIN: $DOMAIN/{flag=1} /Forbidden Paths/{getline; while (\$0 ~ /^-/) {print \$2; getline}} flag && /Typical Failure/{exit}" "$REGISTRY")

          git fetch origin ${{ github.base_ref }} --depth=1
          FILES=$(git diff --name-only origin/${{ github.base_ref }})

          for FILE in $FILES; do
            for BAD in $FORBIDDEN; do
              if [[ "$FILE" == $BAD* ]]; then
                echo "❌ SCOPE VIOLATION: $FILE forbidden for domain $DOMAIN"
                exit 1
              fi
            done

            MATCHED=false
            for OK in $ALLOWED; do
              if [[ "$FILE" == $OK* ]]; then
                MATCHED=true
              fi
            done

            if [ "$MATCHED" = false ]; then
              echo "❌ SCOPE VIOLATION: $FILE not allowed for domain $DOMAIN"
              exit 1
            fi
          done

          echo "✅ Scope-to-diff enforcement passed via registry"
