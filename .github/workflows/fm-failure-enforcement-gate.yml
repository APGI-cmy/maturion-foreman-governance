name: FM Failure Enforcement Gate (Learning → Failure)

on:
  pull_request:
    paths:
      - "architecture/**"
      - ".github/workflows/**"
  push:
    branches:
      - main

jobs:
  fm-failure-enforcement:
    name: Enforce Failure Recording When Learning Indicates Failure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for Evidence-Based Validation (BL-027/028)
        id: evidence_check
        run: |
          echo "=== Evidence-Based Validation Check (BL-027/028) ==="
          echo "Gate: FM Failure Enforcement"
          echo ""
          
          # Look for PREHANDOVER_PROOF with FM failure enforcement validation documented
          if [ -f "PREHANDOVER_PROOF.md" ] && grep -Eqi "Failure.*(Enforcement|enforcement)|FM.*(Failure|failure)" PREHANDOVER_PROOF.md; then
            echo "✅ Found PREHANDOVER_PROOF.md with FM Failure Enforcement validation"
            echo "✅ ACCEPTING evidence-based validation per BL-027/028"
            echo "skip_execution=true" >> $GITHUB_OUTPUT
          elif ls PREHANDOVER_PROOF_*.md 1> /dev/null 2>&1 && grep -Eqi "Failure.*(Enforcement|enforcement)|FM.*(Failure|failure)" PREHANDOVER_PROOF_*.md 2>/dev/null; then
            echo "✅ Found PREHANDOVER_PROOF with FM Failure Enforcement validation"
            echo "✅ ACCEPTING evidence-based validation per BL-027/028"
            echo "skip_execution=true" >> $GITHUB_OUTPUT
          else
            echo "ℹ️  No evidence-based validation found - proceeding with validation"
            echo "skip_execution=false" >> $GITHUB_OUTPUT
          fi

      - name: Resolve active build
        if: steps.evidence_check.outputs.skip_execution != 'true'
        run: |
          if [ ! -f "architecture/BUILD_ACTIVE" ]; then
            echo "ℹ️ No active build (BUILD_ACTIVE missing). Skipping failure enforcement."
            echo "SKIP_VALIDATION=true" >> $GITHUB_ENV
            exit 0
          fi

          BUILD_ID="$(cat architecture/BUILD_ACTIVE | tr -d '\r' | tr -d '\n')"
          BUILD_DIR="architecture/builds/${BUILD_ID}"

          if [ ! -d "$BUILD_DIR" ]; then
            echo "❌ FAILURE BLOCK: build directory missing: $BUILD_DIR"
            exit 1
          fi

          if [ ! -f "${BUILD_DIR}/learning.md" ]; then
            echo "❌ FAILURE BLOCK: learning.md missing for active build."
            exit 1
          fi

          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
          echo "SKIP_VALIDATION=false" >> $GITHUB_ENV

      - name: Determine if learning implies failure
        if: steps.evidence_check.outputs.skip_execution != 'true' && env.SKIP_VALIDATION != 'true'
        run: |
          LEARNING="${BUILD_DIR}/learning.md"

          LEARNING_REQUIRED=$(grep "LEARNING_REQUIRED:" "$LEARNING" | awk '{print $2}')
          AFTER=$(grep "SYSTEM_COMPLETENESS_AFTER:" "$LEARNING" | awk '{print $2}' | tr -d '%')
          BEFORE=$(grep "SYSTEM_COMPLETENESS_BEFORE:" "$LEARNING" | awk '{print $2}' | tr -d '%')

          if [ -z "$AFTER" ] || [ -z "$BEFORE" ]; then
            echo "❌ FAILURE BLOCK: learning.md missing completeness fields."
            exit 1
          fi

          echo "LEARNING_REQUIRED=$LEARNING_REQUIRED" >> $GITHUB_ENV
          echo "BEFORE=$BEFORE" >> $GITHUB_ENV
          echo "AFTER=$AFTER" >> $GITHUB_ENV

          if [ "$LEARNING_REQUIRED" = "YES" ] && [ "$AFTER" -lt 100 ]; then
            echo "FAILURE_REQUIRED=YES" >> $GITHUB_ENV
            echo "Learning indicates failure: completeness after < 100%"
          elif [ "$LEARNING_REQUIRED" = "YES" ] && [ "$AFTER" -lt "$BEFORE" ]; then
            echo "FAILURE_REQUIRED=YES" >> $GITHUB_ENV
            echo "Learning indicates failure: completeness decreased"
          else
            echo "FAILURE_REQUIRED=NO" >> $GITHUB_ENV
            echo "Learning does not mandate failure recording"
          fi

      - name: Enforce presence of failure record(s) when required
        if: env.SKIP_VALIDATION != 'true'
        run: |
          if [ "$FAILURE_REQUIRED" != "YES" ]; then
            echo "✅ Failure recording not required"
            exit 0
          fi

          FAIL_DIR="${BUILD_DIR}/failures"
          if [ ! -d "$FAIL_DIR" ]; then
            echo "❌ FAILURE BLOCK: failures/ directory missing but failure recording is required."
            echo "Agent state: FIX / ESCALATE / HALT. Never conclude."
            exit 1
          fi

          COUNT=$(ls -1 "$FAIL_DIR"/failure-*.md 2>/dev/null | wc -l | tr -d ' ')
          if [ "$COUNT" -lt 1 ]; then
            echo "❌ FAILURE BLOCK: No failure-*.md records found but failure recording is required."
            echo "Agent state: FIX / ESCALATE / HALT. Never conclude."
            exit 1
          fi

          echo "✅ Found $COUNT failure record(s)"

      - name: Enforce effectiveness report exists when failure required
        if: env.SKIP_VALIDATION != 'true'
        run: |
          if [ "$FAILURE_REQUIRED" != "YES" ]; then
            echo "✅ Effectiveness report not required (no failure required)"
            exit 0
          fi

          EFFECT="${BUILD_DIR}/effectiveness.md"
          if [ ! -f "$EFFECT" ]; then
            echo "❌ FAILURE BLOCK: effectiveness.md missing but failure recording is required."
            exit 1
          fi

          echo "✅ effectiveness.md present"

      - name: Failure Enforcement Gate Passed
        if: env.SKIP_VALIDATION != 'true'
        run: |
          echo "✅ FM FAILURE ENFORCEMENT GATE PASSED"
