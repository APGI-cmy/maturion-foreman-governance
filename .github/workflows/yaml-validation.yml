name: YAML Validation

on:
  pull_request:
    paths:
      - '.github/workflows/**/*.yml'
      - '.github/workflows/**/*.yaml'
      - '.github/agents/**/*.md'
      - '.agent'
  push:
    branches:
      - main
    paths:
      - '.github/workflows/**/*.yml'
      - '.github/workflows/**/*.yaml'
      - '.github/agents/**/*.md'
      - '.agent'

permissions:
  contents: read

jobs:
  yamllint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install yamllint
        run: |
          pip install yamllint

      - name: Validate YAML syntax (warnings allowed)
        run: |
          set -euo pipefail
          shopt -s nullglob
          targets=(.github/workflows/*.yml .github/workflows/*.yaml)
          targets+=(.github/agents/*.md)
          if [ -f .agent ]; then
            targets+=(.agent)
          fi
          if [ "${#targets[@]}" -eq 0 ]; then
            echo "✅ No YAML targets found."
            exit 0
          fi

          build_fix_command() {
            local command="yamllint --fix"
            local file
            for file in "$@"; do
              command+=" $(printf '%q' "$file")"
            done
            echo "$command"
          }

          agents_glob=".github/agents/*.md"
          agents_targets=($agents_glob)
          if [ "${#agents_targets[@]}" -eq 0 ]; then
            agents_targets=("$agents_glob")
          fi
          fix_command_agents=$(build_fix_command "${agents_targets[@]}")

          fix_command_all=$(build_fix_command "${targets[@]}")
          output=$(yamllint -f parsable "${targets[@]}" || true)

          if [ -n "$output" ]; then
            echo "$output"
          fi

          if echo "$output" | grep -q '(syntax)'; then
            echo "❌ YAML syntax errors detected."
            echo "Manual fix command: $fix_command_agents"
            echo "Manual fix command (all targets): $fix_command_all"
            exit 1
          fi

          if [ -n "$output" ]; then
            echo "⚠️ yamllint reported style warnings (non-blocking)."
          else
            echo "✅ yamllint found no issues."
          fi
          echo "Manual fix command: $fix_command_agents"
          echo "Manual fix command (all targets): $fix_command_all"
