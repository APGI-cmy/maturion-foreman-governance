name: Governance Layer-Down Dispatch

on:
  push:
    branches:
      - main
    paths:
      - 'governance/canon/**'
      - 'governance/schemas/**'
      - 'governance/templates/**'
      - 'governance/executable/**'
      - 'governance/policy/**'
      - 'governance/runbooks/**'
      - 'governance/CONSUMER_REPO_REGISTRY.json'
      - 'governance/CONSTITUTION.md'
      - 'BUILD_PHILOSOPHY.md'
      - '.github/workflows/governance-layer-down-dispatch.yml'

  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual dispatch (for audit log)'
        required: false
        default: 'manual recovery trigger'
        type: string

permissions:
  contents: read

jobs:
  dispatch-layer-down:
    name: Create Layer-Down Issues in Consumer Repos
    runs-on: ubuntu-latest

    steps:
      - name: Checkout governance repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug working directory
        run: |
          echo "PWD: $PWD"
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          echo "Registry exists: $(test -f governance/CONSUMER_REPO_REGISTRY.json && echo YES || echo NO)"
          echo "Template exists: $(test -f .github/layer-down-issue-template.md && echo YES || echo NO)"

      - name: Detect changed governance artifacts
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "manual dispatch - all canon eligible" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "agent_files_changed=false" >> $GITHUB_OUTPUT
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git show --name-only --pretty=format: HEAD)
            LAYERDOWN_FILES=$(echo "$CHANGED_FILES" | grep -E '^(governance/(canon|schemas|templates|policy|runbooks|executable)/|governance/(CONSUMER_REPO_REGISTRY\.json|CONSTITUTION\.md)|BUILD_PHILOSOPHY\.md|\.github/agents/)' || true)
            echo "changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "$LAYERDOWN_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            AGENT_FILES=$(echo "$CHANGED_FILES" | grep -E '^\.github/agents/.*\.md$' || true)
            if [ -n "$AGENT_FILES" ]; then
              echo "agent_files_changed=true" >> $GITHUB_OUTPUT
            else
              echo "agent_files_changed=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Read consumer registry
        id: registry
        run: |
          REGISTRY="$GITHUB_WORKSPACE/governance/CONSUMER_REPO_REGISTRY.json"
          if [ ! -f "$REGISTRY" ]; then
            echo "FATAL: Consumer registry not found at $REGISTRY"
            ls -la "$GITHUB_WORKSPACE/governance/" || true
            exit 1
          fi
          CONSUMERS=$(jq -r '.consumers[] | select(.enabled == true) | [.repository, (.governance_liaison // "")] | @tsv' "$REGISTRY")
          echo "consumers<<EOF" >> $GITHUB_OUTPUT
          echo "$CONSUMERS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Consumers:"
          echo "$CONSUMERS"

      - name: Create layer-down issues in consumer repos
        env:
          GH_TOKEN: ${{ secrets.MATURION_BOT_TOKEN }}
          CHANGED_FILES: ${{ steps.changes.outputs.changed_files }}
          AGENT_FILES_CHANGED: ${{ steps.changes.outputs.agent_files_changed }}
          CONSUMERS: ${{ steps.registry.outputs.consumers }}
        run: |
          COMMIT_SHA="${{ github.sha }}"
          RAW_MSG="${{ github.event.head_commit.message || github.event.inputs.reason || 'manual recovery trigger' }}"
          COMMIT_MESSAGE=$(python3 -c "
          import sys, re
          msg = sys.argv[1].split('\n')[0]
          print(re.sub(r'[^A-Za-z0-9 ._-]', '-', msg))
          " "$RAW_MSG")
          TIMESTAMP="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          DATE="$(date -u +%Y-%m-%d)"
          SHORT_SHA="${COMMIT_SHA:0:8}"
          ISSUE_TEMPLATE="$GITHUB_WORKSPACE/.github/layer-down-issue-template.md"

          if [ ! -f "$ISSUE_TEMPLATE" ]; then
            echo "FATAL: Issue template not found at $ISSUE_TEMPLATE"
            exit 1
          fi

          FILES_LIST=""
          while IFS= read -r f; do
            [ -z "$f" ] && continue
            FILES_LIST="${FILES_LIST}- ${f}"$'\n'
          done <<< "$CHANGED_FILES"
          [ -z "$FILES_LIST" ] && FILES_LIST="No PUBLIC_API governance files changed in this push."

          AGENT_SECTION=""
          [ "$AGENT_FILES_CHANGED" = "true" ] && AGENT_SECTION="CS2 APPROVAL REQUIRED: Agent contract files changed. Ripple PR must be DRAFT. Only CS2 may merge."

          export COMMIT_SHA COMMIT_MESSAGE TIMESTAMP SHORT_SHA FILES_LIST AGENT_SECTION ISSUE_TEMPLATE

          echo "$CONSUMERS" | while IFS=$'\t' read -r repo liaison; do
            [ -z "$repo" ] && continue
            ISSUE_TITLE="[Layer-Down] Propagate Governance Changes - ${DATE} (${SHORT_SHA})"
            ISSUE_BODY=$(python3 "$GITHUB_WORKSPACE/.github/scripts/fill-layer-down-template.py")
            echo "Creating issue in $repo..."
            CREATE_ARGS=(-f "title=$ISSUE_TITLE" -f "body=$ISSUE_BODY" -f "labels[]=governance" -f "labels[]=layer-down" -f "labels[]=high-priority")
            [ -n "$liaison" ] && CREATE_ARGS+=(-f "assignees[]=$liaison")
            gh api repos/$repo/issues -X POST -H "Accept: application/vnd.github+json" "${CREATE_ARGS[@]}" \
              && echo "  Issue created in $repo" \
              || { echo "  Issue creation FAILED for $repo"; echo "issue-create:$repo" >> /tmp/dispatch-failures.txt; }
          done

      - name: Dispatch governance_ripple to consumer repos
        env:
          GH_TOKEN: ${{ secrets.RIPPLE_DISPATCH_TOKEN || secrets.MATURION_BOT_TOKEN }}
          CONSUMERS: ${{ steps.registry.outputs.consumers }}
          AGENT_FILES_CHANGED: ${{ steps.changes.outputs.agent_files_changed }}
        run: |
          COMMIT_SHA="${{ github.sha }}"
          RAW_MSG="${{ github.event.head_commit.message || github.event.inputs.reason || 'manual recovery trigger' }}"
          COMMIT_MESSAGE=$(python3 -c "
          import sys, re
          msg = sys.argv[1].split('\n')[0]
          print(re.sub(r'[^A-Za-z0-9 ._-]', '-', msg))
          " "$RAW_MSG")
          SHORT_SHA="${COMMIT_SHA:0:8}"
          TIMESTAMP="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "$CONSUMERS" | while IFS=$'\t' read -r repo liaison; do
            [ -z "$repo" ] && continue
            echo "Dispatching governance_ripple to $repo..."
            gh api "repos/$repo/dispatches" \
              -X POST \
              -H "Accept: application/vnd.github+json" \
              -f "event_type=governance_ripple" \
              -f "client_payload[source_repo]=${{ github.repository }}" \
              -f "client_payload[commit_sha]=${COMMIT_SHA}" \
              -f "client_payload[short_sha]=${SHORT_SHA}" \
              -f "client_payload[timestamp]=${TIMESTAMP}" \
              -f "client_payload[agent_files_changed]=${AGENT_FILES_CHANGED}" \
              -f "client_payload[commit_message]=${COMMIT_MESSAGE}" \
              && echo "  dispatched to $repo" \
              || { echo "  dispatch FAILED for $repo"; echo "ripple-dispatch:$repo" >> /tmp/dispatch-failures.txt; }
          done

      - name: Record layer-down dispatch
        run: |
          mkdir -p .agent-admin/ripple
          TIMESTAMP="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          DATESTAMP="$(date +%Y%m%d-%H%M%S)"
          printf '{"schema_version":"1.0.0","type":"layer_down_dispatch","timestamp":"%s","commit_sha":"%s","consumers_notified":%s}\n' \
            "$TIMESTAMP" \
            "${{ github.sha }}" \
            "$(jq -c '[.consumers[] | select(.enabled == true) | .repository]' "$GITHUB_WORKSPACE/governance/CONSUMER_REPO_REGISTRY.json")" \
            > ".agent-admin/ripple/layer-down-dispatch-${DATESTAMP}.json"
          echo "Dispatch recorded."

      - name: Upload dispatch failure log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dispatch-failure-log-${{ github.run_number }}
          path: /tmp/dispatch-failures.txt
          if-no-files-found: ignore

      - name: Fail job if any dispatches failed
        if: always()
        run: |
          if [ -f /tmp/dispatch-failures.txt ] && [ -s /tmp/dispatch-failures.txt ]; then
            echo "::error::One or more layer-down dispatch operations failed (see 'dispatch-failure-log-${{ github.run_number }}' artifact):"
            cat /tmp/dispatch-failures.txt
            exit 1
          fi
          echo "All layer-down dispatch operations completed successfully."