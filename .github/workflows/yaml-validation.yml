name: YAML Validation

on:
  pull_request:
    paths:
      - '.github/workflows/**/*.yml'
      - '.github/workflows/**/*.yaml'
      - '.github/agents/**/*.md'
      - '.agent'
  push:
    branches:
      - main
    paths:
      - '.github/workflows/**/*.yml'
      - '.github/workflows/**/*.yaml'
      - '.github/agents/**/*.md'
      - '.agent'

permissions:
  contents: read

jobs:
  yamllint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install yamllint
        run: |
          pip install yamllint

      - name: Validate YAML syntax (warnings allowed)
        run: |
          set -euo pipefail
          shopt -s nullglob
          targets=(.github/workflows/*.yml .github/agents/*.md)
          if [ -f .agent ]; then
            targets+=(.agent)
          fi
          if [ "${#targets[@]}" -eq 0 ]; then
            echo "✅ No YAML targets found."
            exit 0
          fi

          agents_targets=(.github/agents/*.md)
          if [ "${#agents_targets[@]}" -gt 0 ]; then
            fix_command_agents="yamllint --fix ${agents_targets[*]}"
          else
            fix_command_agents="yamllint --fix .github/agents/*.md"
          fi

          fix_command_all="yamllint --fix ${targets[*]}"
          output=$(yamllint -f parsable "${targets[@]}" || true)

          if [ -n "$output" ]; then
            echo "$output"
          fi

          if echo "$output" | grep -q '(syntax)'; then
            echo "❌ YAML syntax errors detected."
            echo "Manual fix command: $fix_command_agents"
            echo "Manual fix command (all targets): $fix_command_all"
            exit 1
          fi

          if [ -n "$output" ]; then
            echo "⚠️ yamllint reported style warnings (non-blocking)."
          else
            echo "✅ yamllint found no issues."
          fi
          echo "Manual fix command: $fix_command_agents"
          echo "Manual fix command (all targets): $fix_command_all"
