name: Governance Scope-to-Diff Enforcement

on:
  push:
    branches-ignore:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  scope-to-diff-validation:
    name: Validate Scope Declaration Matches Diff
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for PREHANDOVER_PROOF evidence-based validation
        id: check_evidence
        run: |
          echo "Checking for evidence-based validation in PREHANDOVER_PROOF..."
          
          # Check if PREHANDOVER_PROOF.md exists
          if [ -f "PREHANDOVER_PROOF.md" ]; then
            echo "evidence_file_exists=true" >> $GITHUB_OUTPUT
            
            # Check if it contains scope-to-diff validation evidence
            if grep -qi "scope.*to.*diff\|scope.*declaration" PREHANDOVER_PROOF.md; then
              echo "evidence_found=true" >> $GITHUB_OUTPUT
              echo "‚úì PREHANDOVER_PROOF.md contains scope validation evidence"
              
              # Check for attestation/signature
              if grep -qi "attestation\|signature\|manually verified\|evidence-based" PREHANDOVER_PROOF.md; then
                echo "attestation_found=true" >> $GITHUB_OUTPUT
                echo "‚úì Attestation/signature found in PREHANDOVER_PROOF"
              else
                echo "attestation_found=false" >> $GITHUB_OUTPUT
                echo "‚ö†Ô∏è No attestation/signature found in PREHANDOVER_PROOF"
              fi
            else
              echo "evidence_found=false" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è PREHANDOVER_PROOF.md exists but no scope validation evidence found"
            fi
          else
            echo "evidence_file_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è PREHANDOVER_PROOF.md not found"
          fi

      - name: Enforce scope-to-diff via registry (script execution path)
        id: script_validation
        continue-on-error: true
        run: |
          DOMAIN=$(grep "RESPONSIBILITY_DOMAIN:" governance/scope-declaration.md | cut -d':' -f2 | xargs)

          REGISTRY="governance/canon/RESPONSIBILITY_DOMAIN_REGISTRY.md"
          if ! grep -q "### DOMAIN: $DOMAIN" "$REGISTRY"; then
            echo "‚ùå GOVERNANCE BLOCK: Responsibility domain '$DOMAIN' is not registered."
            exit 1
          fi

          echo "Using responsibility domain: $DOMAIN"

          ALLOWED=$(awk "/### DOMAIN: $DOMAIN/{flag=1} /Allowed Paths/{getline; while (\$0 ~ /^-/) {print \$2; getline}} flag && /Forbidden Paths/{exit}" "$REGISTRY")
          FORBIDDEN=$(awk "/### DOMAIN: $DOMAIN/{flag=1} /Forbidden Paths/{getline; while (\$0 ~ /^-/) {print \$2; getline}} flag && /Typical Failure/{exit}" "$REGISTRY")

          git fetch origin ${{ github.base_ref }} --depth=1
          FILES=$(git diff --name-only origin/${{ github.base_ref }})

          for FILE in $FILES; do
            for BAD in $FORBIDDEN; do
              # Strip backticks and handle /** pattern
              BAD_CLEAN=$(echo "$BAD" | tr -d '`')
              BAD_CLEAN="${BAD_CLEAN%/**}"
              if [[ "$FILE" == $BAD_CLEAN* ]]; then
                echo "‚ùå SCOPE VIOLATION: $FILE forbidden for domain $DOMAIN"
                exit 1
              fi
            done

            MATCHED=false
            for OK in $ALLOWED; do
              # Strip backticks and handle /** pattern
              OK_CLEAN=$(echo "$OK" | tr -d '`')
              OK_CLEAN="${OK_CLEAN%/**}"
              if [[ "$FILE" == $OK_CLEAN* ]]; then
                MATCHED=true
              fi
            done

            if [ "$MATCHED" = false ]; then
              echo "‚ùå SCOPE VIOLATION: $FILE not allowed for domain $DOMAIN"
              exit 1
            fi
          done

          echo "‚úÖ Scope-to-diff enforcement passed via registry"
          echo "script_passed=true" >> $GITHUB_OUTPUT

      - name: Determine validation result
        id: determine_result
        run: |
          SCRIPT_PASSED="${{ steps.script_validation.outcome }}"
          EVIDENCE_EXISTS="${{ steps.check_evidence.outputs.evidence_file_exists }}"
          EVIDENCE_FOUND="${{ steps.check_evidence.outputs.evidence_found }}"
          ATTESTATION_FOUND="${{ steps.check_evidence.outputs.attestation_found }}"
          
          echo "==================================="
          echo "Scope-to-Diff Validation Results"
          echo "==================================="
          echo ""
          echo "Script execution path: $SCRIPT_PASSED"
          echo "Evidence-based path available: $EVIDENCE_EXISTS"
          echo "Evidence found: $EVIDENCE_FOUND"
          echo "Attestation found: $ATTESTATION_FOUND"
          echo ""
          
          # Check Path 1: Script execution succeeded
          if [ "$SCRIPT_PASSED" = "success" ]; then
            echo "‚úÖ PASS: Script execution path succeeded"
            echo "result=pass" >> $GITHUB_OUTPUT
            echo "method=script" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check Path 2: Evidence-based validation
          if [ "$EVIDENCE_EXISTS" = "true" ] && [ "$EVIDENCE_FOUND" = "true" ] && [ "$ATTESTATION_FOUND" = "true" ]; then
            echo "‚úÖ PASS: Evidence-based validation path accepted"
            echo "result=pass" >> $GITHUB_OUTPUT
            echo "method=evidence" >> $GITHUB_OUTPUT
            echo ""
            echo "Note: This PR used evidence-based validation (BL-027 compliant)"
            echo "PREHANDOVER_PROOF contains manual scope verification with attestation"
            exit 0
          fi
          
          # Neither path succeeded - FAIL
          echo "‚ùå FAIL: Neither validation path succeeded"
          echo "result=fail" >> $GITHUB_OUTPUT
          echo "method=none" >> $GITHUB_OUTPUT
          echo ""
          echo "BL-027 requires scope-to-diff validation via ONE of these paths:"
          echo ""
          echo "PATH 1: Script Execution (Preferred)"
          echo "  - Scope declaration exists: $([[ -f governance/scope-declaration.md ]] && echo '‚úÖ' || echo '‚ùå')"
          echo "  - Script validation passed: $([[ $SCRIPT_PASSED = 'success' ]] && echo '‚úÖ' || echo '‚ùå')"
          echo ""
          echo "PATH 2: Evidence-Based Validation (Agent Environments)"
          echo "  - PREHANDOVER_PROOF exists: $([[ $EVIDENCE_EXISTS = 'true' ]] && echo '‚úÖ' || echo '‚ùå')"
          echo "  - Contains scope validation: $([[ $EVIDENCE_FOUND = 'true' ]] && echo '‚úÖ' || echo '‚ùå')"
          echo "  - Contains attestation: $([[ $ATTESTATION_FOUND = 'true' ]] && echo '‚úÖ' || echo '‚ùå')"
          echo ""
          echo "See .github/scripts/README.md for detailed examples of both paths"
          echo ""
          exit 1

      - name: Post validation report (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const result = '${{ steps.determine_result.outputs.result }}';
            const method = '${{ steps.determine_result.outputs.method }}';
            const scriptPassed = '${{ steps.script_validation.outcome }}' === 'success';
            
            let comment = '## üéØ Scope-to-Diff Validation (BL-027)\n\n';
            
            if (result === 'pass') {
              comment += `**Status**: ‚úÖ PASSED\n`;
              comment += `**Method**: ${method === 'script' ? 'Script Execution' : 'Evidence-Based Validation'}\n\n`;
              
              if (method === 'evidence') {
                comment += '**Note**: This PR used evidence-based validation, which is compliant with BL-027 for agent environments where script execution is not available before PR creation.\n\n';
                comment += 'Evidence includes:\n';
                comment += '- Manual scope declaration\n';
                comment += '- Comparison against git diff\n';
                comment += '- Attestation/signature in PREHANDOVER_PROOF\n\n';
              }
            } else {
              comment += `**Status**: ‚ùå FAILED\n\n`;
              comment += '**Required**: BL-027 mandates scope-to-diff validation via ONE of these paths:\n\n';
              comment += '### Path 1: Script Execution (Preferred)\n';
              comment += '```bash\n';
              comment += './.github/scripts/validate-scope-to-diff.sh main\n';
              comment += '# Exit code must be 0\n';
              comment += '```\n\n';
              comment += '### Path 2: Evidence-Based Validation (Agent Environments)\n';
              comment += '- Create `PREHANDOVER_PROOF.md` in PR root\n';
              comment += '- Document manual scope-to-diff comparison\n';
              comment += '- Include attestation that all files match\n';
              comment += '- Sign with agent name and timestamp\n\n';
              comment += '**Example**: See `.github/scripts/README.md` for detailed examples\n\n';
            }
            
            comment += '---\n';
            comment += '*Authority: BL-027 (Scope Declaration Mandatory Before PR Handover)*\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Final gate status
        run: |
          if [ "${{ steps.determine_result.outputs.result }}" = "pass" ]; then
            echo "‚úÖ Scope-to-Diff Gate PASSED"
            exit 0
          else
            echo "‚ùå Scope-to-Diff Gate FAILED"
            exit 1
          fi
